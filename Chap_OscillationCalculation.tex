\chapter{Oscillation Probability Calculation}
\label{chap:OscillationProbability}

The calculation of the oscillation probability is crucial to the reliability of the sensitivity measurements of the analysis presented within this thesis. Firstly, it is important to understand how and where the sensitivity to the oscillation parameters comes from for both atmospheric and beam samples. An overview of how these sets of samples observe changes in \dcp, \delmsqatm, and \sinsqatm as well as how the atmospheric samples have an increased sensitivity to mass hierarchy determination is given in \autoref{sec:Oscillation_Overview}. It also explains the additional complexities involved when including atmospheric neutrinos as compared to a beam-only analysis.

Without additional techniques, atmospheric sub-GeV upward-going neutrinos can artificially inflate the sensitivity to \dcp due to the quickly varying oscillation probability in this region. Therefore, a ``sub-sampling'' approach has been developed to reduce these biases ensuring accurate and reliable sensitivity measurements. This technique ensures that small-scale unresolvable features of the oscillation probability have been averaged over whilst the large-scale resolvable features in the oscillation probability have been kept. The documentation of this technique is found in \autoref{sec:Oscillation_FastOscillations} alongside the validation of the choices which have been made. The \texttt{CUDAProb3} implementation choice made within the fitting framework, as detailed in \autoref{sec:Oscillation_CalculationEngine}, ensures that the analysis can be done in a timely manner.

Whilst the beam neutrinos are assumed to propagate through a constant density slab of material, the density variations through the Earth result in more complex oscillation patterns Furthermore, the uncertainty in the electron density can modify the oscillation probability for the denser core layers of the Earth. \autoref{sec:Oscillation_MatterDensity} details the model of the Earth used within this analysis. This includes the official SK-only methodology as well as relatively straightforward improvements that can be made to more closely approximate the PREM model. Another quirk of atmospheric neutrinos oscillation studies is that the height of production in the atmosphere is not known on an event-by-event analysis. An analytical averaging technique that approximates the uncertainty of the oscillation probability has been followed, with the author of this thesis being responsible for the implementation and validation. This technique is illustrated in \autoref{sec:Oscillation_ProdHAvergaing} alongside the variation in oscillation probability which would be an expected effect in the down-going and horizontal-going neutrinos.

\section{Overview}
\label{sec:Oscillation_Overview}

The analysis presented within this thesis focuses on the determination of oscillation parameters from atmospheric and beam neutrinos. Whilst subject to the same oscillation probability, the way in which the two sets of samples have sensitivity to the different oscillation parameters differs quite significantly.

Atmospheric neutrinos have a varying baseline, or ``path length'', such that the distance each neutrino travels before interacting is dependent upon the zenith angle. Therefore the oscillation probability can be represented as a two-dimensional ``oscillogram'' as shown in \autoref{fig:Oscillation_SK_BasicOscillogram}. For this calculation, four layers of fixed density were used to model the Earth with values taken from an approximation of the PREM model. These can be seen in the distinct discontinuities in the oscillogram as a function of the zenith angle.

Another complexity of atmospheric neutrino oscillation probability calculation is the uncertainty in the height at which a neutrino was produced, termed the ``production height''. Primary cosmic rays, which contribute most of the neutrino flux, can interact anywhere between the Earth's surface and \quickmath{\sim50\text{km}} above that. The baseline, \quickmath{L}, for a neutrino generated with zenith angle, \quickmath{\theta}, and production height, \quickmath{h}, can be calculated as

\begin{equation}
  L = \sqrt{\left(R_{E} + h\right)^{2} - R_{E}^{2} \left(1 - \cos^{2} \left(\theta \right) \right)} - R_{E}\cos(\theta),
\end{equation}

where \quickmath{R_{E} = 6,371\text{km}} is the Earth's radius.

\begin{figure}[h]
  \begin{subfigure}[t]{0.8\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/BasicOscillogramWithNotes.pdf}
  \end{subfigure}
  \caption{An ``Oscillogram'' that depicts the \quickmath{P(\nu_\mu \rightarrow \nu_e)} oscillation probability as a function of neutrino energy and cosine of the zenith angle. The zenith angle is defined such that \quickmath{\cos(\theta_{Z}) = 1.0} represents neutrinos that travel from directly above the detector. The four-layer constant density PREM model approximation is used and Asimov A oscillation parameters are assumed.}
  \label{fig:Oscillation_SK_BasicOscillogram}
\end{figure}

Atmospheric neutrinos do have some sensitivity to \dcp through a normalisation term. \autoref{fig:Oscillation_SK_DCPSensitivity} illustrates the difference in oscillation probability between CP-conserving and CP-violating \dcp values. The result is a complicated oscillation pattern in the appearance probability for sub-GeV upgoing neutrinos. The detector does not have sufficient resolution to resolve these individual patterns so the sensitivity to \dcp for atmospheric neutrinos comes via the overall normalisation of the sub-GeV upgoing events. The presence of matter means that the effect \dcp has on the oscillation probability is not equal between neutrinos and antineutrinos which would be expected when propagating through a vacuum. This is further extenuated by the fact that SK can not distinguish neutrinos and antineutrinos well and that the cross-section neutrino interaction is larger than that for antineutrinos. Finally, sample selections (discussed in \finish{Link to selection chapter}) targeting different neutrino interaction modes (charge current quasi-elastic and single pion production) result in an imbalance in the percentage of neutrinos to anti-neutrinos in these samples due to pion capture. Negatively charged pions from antineutrino interactions are more likely to be captured by a nucleus compared to a positively charged pion emitted from a neutrino interaction. This all culminates in atmospheric neutrinos having a very complex sensitivity to \dcp.

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/AtmDCPSens.pdf}
  \end{subfigure}
  \caption{The effect of \dcp for atmospheric neutrinos given in terms of the neutrino energy and zenith angle. The oscillogram compares the \quickmath{P(\nu_{\mu} \rightarrow \nu_{e})} oscillation probability for a CP conserving (\quickmath{\delta_{CP}=0.0}) and CP violating (\quickmath{\delta_{CP}=-1.601}) value of \dcp. The other oscillation parameters assume the ``Asimov A'' oscillation parameter set given in \autoref{tab:Oscillation_ParameterSets}.}
  \label{fig:Oscillation_SK_DCPSensitivity}
\end{figure}

Atmospheric neutrinos are subject to matter effects as they travel through the dense matter in the Earth. The vacuum and matter oscillation probabilities for \quickmath{P(\nu_{e} \rightarrow \nu_{e})} and \quickmath{P(\bar{\nu}_{e} \rightarrow \bar{\nu}_{e})} are presented in \autoref{fig:Oscillation_SK_VacuumMatter}. The oscillation probability for both neutrinos and antineutrinos are affected in the presence of matter but the resonance (Effects around \quickmath{E_{\nu} \sim 5\text{GeV}}) only occurs for neutrinos in normal mass hierarchy and antineutrinos for inverse mass ordering. The exact position and amplitude of the resonance depend on \sinsqatm meaning that the atmospheric neutrinos have sensitivity to the octant of \quickmath{\theta_{23}}. 

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/MatterEffect.pdf}
  \end{subfigure}
  \caption{An illustration of the matter-induced effects on the oscillation probability, given as a function of neutrino energy and zenith angle. The top row of panels gives the \quickmath{P(\nu_{e} \rightarrow \nu_{e})} oscillation probability and the bottom row illustrates the \quickmath{P(\bar{\nu}_{e} \rightarrow \bar{\nu}_{e})} oscillation probability. The left coloumn highlights the oscillation probability in a vacuum, whereas the middle and right column represents the oscillation probabilities when the four layer fixed density PREM model is assumed. All oscillation probabilities assume the ``Asimov A'' set given in \autoref{tab:Oscillation_ParameterSets}, but importantly, the right column sets an inverted mass hierarchy. The ``matter resonance'' effects at \quickmath{E_{\nu} \sim 5\text{GeV}} can be seen in the \quickmath{P(\nu_{e} \rightarrow \nu_{e})} for normal mass hierarchy and \quickmath{P(\bar{\nu}_{e} \rightarrow \bar{\nu}_{e})} for inverted hierarchy.}
  \label{fig:Oscillation_SK_VacuumMatter}
\end{figure}

As the T2K beam flux is centered at the first oscillation maximum, the sensitivity to \dcp is predominantly observed as a change in the event-rate of e-like samples in \quickmath{\nu/\bar{\nu}} modes. \autoref{fig:Oscillation_T2K_OscillationProbSensitivity} illustrates the \quickmath{P(\nu_\mu \rightarrow \nu_e)} oscillation probability for a range of \dcp values. %The magnitude of the oscillation peak has an approximate factor of two difference between the CP-violating values \quickmath{\delta_{CP} = \pm\pi/2} and the difference in oscillation probability between the CP-conserving
A circular modulation of the oscillation peak (in both magnitude and position) is observed when varying throughout the allowable values of \dcp. The CP-conserving values of \quickmath{\delta_{CP}=0,\pi} have a lower(higher) oscillation maximum than the CP-violating values of \quickmath{\delta_{CP}=-\pi/2}(\quickmath{\delta_{CP}=\pi/2}) leading to a \quickmath{\sin(\delta_{CP})} type sensitivity. A sub-dominant shift in the energy of the oscillation peak is also present to aid in separating the two CP-conserving values of \dcp.

\begin{figure}[h]
  \begin{subfigure}[t]{0.5\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/T2K_NuMu_x_NuMu_DelMsq32Sens.pdf}
    \subcaption{\delmsqatm}
  \end{subfigure}%
  \begin{subfigure}[t]{0.5\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/T2K_NuMu_x_NuMu_Sinsqth23Sens.pdf}
    \subcaption{\sinsqatm}
  \end{subfigure}
  \begin{subfigure}[t]{0.5\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/T2K_NuMu_x_NuE_DCPSens.pdf}
    \subcaption{\dcp}
  \end{subfigure}
  \caption{The oscillation probability for beam neutrino events given as a function of neutrino energy. All oscillation parameters assume the ``Asimov A'' set given in \autoref{tab:Oscillation_ParameterSets} unless otherwise stated. Each panel represents a change in one of the oscillation parameters whilst keeping the remaining parameters fixed.}
  \label{fig:Oscillation_T2K_OscillationProbSensitivity}
\end{figure}

T2K's sensitivity to the atmospheric oscillation parameters is more of a shape-based variation of the muon-like samples, as illustrated in \autoref{fig:Oscillation_T2K_OscillationProbSensitivity}. The value of \quickmath{\Delta m^{2}_{32}} laterally shifts the position of the oscillation dip (around \quickmath{E_\nu \sim 0.6\text{GeV}}) in the \quickmath{P(\nu_\mu \rightarrow \nu_\mu)} oscillation probability. A variation of \sinsqatm is predominantly observed as a vertical shift of the oscillation dip with second-order horizontal shifts being due to matter effects. The beam neutrinos have limited sensitivity to matter effects due to the shorter baseline as well as the Earth's mantle is relatively low-density material (as compared to the Earth's core). For some values of \dcp, the degeneracy in the number of e-like events allows the mass hierarchy to be resolved. This leads to a \dcp-dependent mass hierarchy sensitivity which can be seen in \autoref{fig:Oscillation_SK_BiProbabilityPlot}.

\begin{figure}[h]
  \begin{subfigure}[t]{0.65\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/BiProbabilityPlot.pdf}
  \end{subfigure}
  \caption{The number of electron-like events in the FHC and RHC operating mode of the beam, as a function of the oscillation probabilities. Both normal hierarchy (Solid)) and inverse hierarchy (Dashed) values of \delmsqatm are given.}
  \label{fig:Oscillation_SK_BiProbabilityPlot}
\end{figure}

Whilst all oscillation channels should be included for completeness, the computational resources required to run a fit are limited and any reasonable approximations which reduce the number of oscillation probability calculations that need to be made should be applied. The \quickmath{\nu_{e} \rightarrow \nu_{e,\mu,\tau}} (and antineutrino equivalent) oscillations can be ignored for beam neutrinos as the \quickmath{\nu_{e}/\bar{\nu}_{e}} fluxes being approximately two orders of magnitude smaller than the corresponding \quickmath{\nu_{\mu}/\bar{\nu}_{\mu}} flux. Furthermore, as the peak neutrino energy of the beam is well below the threshold for \quickmath{\tau} production (\quickmath{E_\nu \sim 3\text{GeV}} \cite{Machado2020}) only a small proportion of the neutrinos produced in the beam have the required energy. For the few neutrinos that have sufficient energy, the oscillation probability is very small due to the short baseline. Whilst these approximations can be made for the beam neutrinos, the atmospheric flux of \quickmath{\nu_{e}} is of the same order of magnitude as the \quickmath{\nu_{\mu}} flux and the energy distribution of atmospheric neutrinos extends well above the tau production threshold.

Throughout this thesis, several spectra predictions, Asimov fits, and contour comparisons are presented which require oscillation parameters to be assumed. \autoref{tab:Oscillation_ParameterSets} defines two sets of oscillation parameters, with ``Asimov A'' set being close to the preferred values from a previous T2K-only fit \cite{PhysRevLett.112.181801} and ``Asimov B'' being CP-conserving and further from maximal \quickmath{\theta_{23}} mixing.

\begin{table}[ht!]
    \centering
    \begin{tabular}{c|c|c}
      \hline
      \hline
      Parameter & Asimov A & Asimov B \\
      \hline
      \quickmath{\Delta m^{2}_{12}} & \multicolumn{2}{c}{\quickmath{7.53 \times 10^{-5} \text{eV}^{2}}} \\ \hline
      \quickmath{\Delta m^{2}_{32}} & \multicolumn{2}{c}{\quickmath{2.509 \times 10^{-3} \text{eV}^{2}}} \\ \hline
      \quickmath{\sin^{2}\left(\theta_{12}\right)} & \multicolumn{2}{c}{\quickmath{0.304}} \\ \hline
      \quickmath{\sin^{2}\left(\theta_{13}\right)} & \multicolumn{2}{c}{\quickmath{0.0219}} \\ \hline
      \quickmath{\sin^{2}\left(\theta_{23}\right)} & \quickmath{0.528} & \quickmath{0.45} \\ \hline
      \quickmath{\delta_{CP}} & \quickmath{-1.601} & \quickmath{0.0} \\ \hline
      \hline
    \end{tabular}
    \caption{Reference values of the neutrino oscillation parameters for two different oscillation parameter sets.}
    \label{tab:Oscillation_ParameterSets}
\end{table}

\section{Treatment of Fast Oscillations}
\label{sec:Oscillation_FastOscillations}

As shown in \autoref{fig:Oscillation_SK_FastOscillogram}, atmospheric neutrino oscillations have a significantly more complex structure for upgoing neutrinos with energy below \quickmath{1\text{GeV}}. This is because the \quickmath{L/E} dependence of the oscillation probability in this region induces rapid variations for small changes in \quickmath{L} or \quickmath{E}. As discussed in \autoref{sec:Oscillation_Overview}, this is also the region in which atmospheric neutrinos have sensitivity to \dcp. In practice, the direction between the detector and a neutrino's production vertex is inferred from the direction of any secondary particles created in the detector target. For low-energy neutrinos, this inference can be rather poor and introduces a distinct difference to beam neutrinos where the direction to production vertex is very well known.

As a consequence of the poor detector resolution, an average oscillation probability is observed in this region. This creates a computational problem as a significantly large amount of MC statistics would be required to accurately predict the number of events in each bin if MC averaging was the only technique used. This section describes the `sub-sampling' approach developed for this analysis and compares it to the methodology used within the SK-only analysis.

\begin{figure}[h]
  \begin{subfigure}[t]{0.8\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/FastOscillationExample.pdf}
  \end{subfigure}
  \caption{The oscillation probability \quickmath{P(\nu_{\mu} \rightarrow \nu_{e})}, given as a function of neutrino energy and zenith angle, which highlights an example of the ``fast'' oscillations in the sub-GeV upgoing region.}
  \label{fig:Oscillation_SK_FastOscillogram}
\end{figure}

The official SK-only analysis uses the osc3++ oscillation parameter fitter \cite{thesis_roger}. To perform the fast oscillation averaging, it uses a 'nearest-neighbour' technique. For a given neutrino MC event, the nearest neighbours in reconstructed lepton momentum and zenith angle are found and a distribution of neutrino energies is built. This distribution is then used to compute an average oscillation probability for the given neutrino MC event. 

For the \quickmath{i^{th}} event, the oscillation weight is calculated as

\begin{equation}
  W_{i} = \frac{1}{5} P(E_{i},\bar{L}_{i}) + \frac{1}{5} \sum_{\beta = -1, -0.5, 0.5, 1} P(E_{i} + \beta\sigma_{i},L_{\beta}),
\end{equation}

where \quickmath{P(E,L)} is the oscillation probability calculation for neutrino energy \quickmath{E} and path length \quickmath{L}, \quickmath{\sigma_{i}} is the RMS of the energy distribution for the given event, and the two path lengths, \quickmath{\bar{L}_{i}} and \quickmath{L_{\beta}} are discussed below. In practice, twenty of the nearest neighbours are used to generate the neutrino energy distribution. All of the oscillation probability calculations are performed with a fixed zenith angle (and therefore have same matter density profile).

The uncertainty in the production height is controlled by using an ``average'' production height. \quickmath{\bar{L}_{i}} represents the average path length computed using twenty production heights taken from the Honda flux model's prediction \cite{Honda:2011} for a fixed zenith angle, where the production heights are sampled in steps of \quickmath{5\%} of their cumulative distribution function. \quickmath{L_{\beta}} values are similarly calculated but instead use different combinations of four production heights (sampled in the same way),

\begin{equation}
  \begin{split}
    L_{-1.0} &= \frac{1}{4} L(45,50,55,60), \\
    L_{-0.5} &= \frac{1}{4} L(35,40,65,70), \\
    L_{+0.5} &= \frac{1}{4} L(25,30,75,68), \\
    L_{+1.0} &= \frac{1}{4} L(15,20,85,89). \\
  \end{split}
\end{equation}

This averaging works well because of the correlation between the true neutrino zenith angle and the inferred direction from secondary particles in the detector. For low-energy neutrinos, where the resolution of the true neutrino direction is poor, \quickmath{\sigma_{i}} will be large, resulting in significant averaging effects. Contrary to this, the inferred direction of high-energy neutrinos will be much closer to the true value, meaning that \quickmath{\sigma_{i}} will be smaller.

In practice, this technique is performed before the fit in order to deal with the computational cost. Oscillation probabilities are pre-calculated on a 4D grid. This is possible as the Osc3++ framework uses binned oscillation parameters rather than continuous so the oscillation parameters used in the fit are known prior to run-time. The framework used in the analysis presented within this thesis uses continuous oscillation parameters. Due to the MCMC technique invoked within the fitter (see \autoref{chap:MarkovChainMonteCarlo}), there is no way to know which oscillation parameter values will be selected in each step at run-time. Therefore, the oscillation parameter calculation would have to be performed at run-time which is very expensive for event-by-event reweighting. Having to compute five oscillation probabilities per event would require far too many computational resources to be viable so the SK technique can not be used within this analysis. However, the concept of the averaging technique can be taken from it.

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/SubSamplingExample.pdf}
  \end{subfigure}
  \caption{Illustration of the averaging procedure for \quickmath{N=2}. The oscillation probabilities calculated on the finer left binning are averaged to obtain the oscillation probabilities in the coarser right binning. These averaged oscillation probabilities with the coarser binning are then applied to each event during the fit.}
  \label{fig:Oscillation_SK_SubSamplingExample}
\end{figure}

This analysis uses a binned oscillogram in which oscillation probabilities for a given event are selected based on that event's attributes. To perform a similar averaging as the SK analysis, a sub-sampling approach has been devised. The technique can be explained by considering a ``fine'' and ``coarse'' oscillogram. The fine oscillograms are used to define the array of cosine zeniths and energies for the neutrino oscillation engine. The coarse oscillograms cover the same phase-space as the fine oscillograms but have fewer bins in that range. Then, for a given coarse oscillogram bin, the value of that bin will be taken as the average of all the oscillation probabilities of all the fine oscillogram bins which fall into that coarse oscillogram bin.

The binning which is used to calculate the oscillation probabilities, known as the `fine' binning, has \quickmath{N \times N} subdivisions per coarse bin. The value assigned to a coarse bin is the linear average (flat prior in \quickmath{E_{\nu}} and \quickmath{\cos(\theta_{Z})}) of all the oscillation probabilities calculated at the center of each fine bin contained within that coarse bin. \autoref{fig:Oscillation_SK_SubSamplingExample} illustrates the \quickmath{N = 2} example where the assigned value to a coarse bin is the linear average of the four fine bins which fall in that coarse bin. Whilst the coarse bin edges are not linear on either axis, the sub-division of the fine bins is linear over the range of a coarse bin. The alignment of the fine and coarse binning edges is checked at run-time.

The coarse binning is defined with \quickmath{67 \times 52} bins in true neutrino energy \quickmath{\times} cosine zenith. In general, the binning is logarithmically spaced in neutrino energy but has some hand-picked bin edges. Firstly, the bin density around the matter resonance is smoothly increased around the matter resonance region. This is to avoid smearing this region which can be well sampled by the Monte Carlo. Secondly, bin edges are selected to hit \quickmath{0.4, 0.6, 1, 10, 30, 50, 100 \text{GeV}}. This is to ensure that the Coloumb correction systematic and the atmospheric flux systematics definitions in neutrino energy can be hit. The cosine zenith binning is approximately linearly spaced across the allowable range but the values of layer transitions are hit precisely; \quickmath{-0.8376} (core-mantle) and \quickmath{-0.4464} (mantle/transition zone). Bins are spread further apart for downgoing events as this is a region unaffected by the fast oscillation wavelengths and reduces the total number of calculations required to perform the reweight (Not the number required to perform the oscillation calculation).

The choice of \quickmath{N} is justified based on two studies. Firstly, the variation of event rates of each sample is studied as a function of the number of subdivisions. For a given set of oscillation parameters thrown from the PDG prior constraints, the oscillation probabilities are calculated using a given value of \quickmath{N}. Each sample is re-weighted and the event rate is stored. The value of \quickmath{N} is scanned from \quickmath{1}, which corresponds to no averaging, to \quickmath{24}, which corresponds to the largest computationally viable subdivision binning. The event rate of each sample at large \quickmath{N} is expected to converge to a stationary value due to the fine binning fully sampling the small-scale structure. \autoref{fig:Oscillation_SK_EventRateVariable} illustrates this behaviour for the \texttt{SubGeV\_elike\_0dcy} sample for \quickmath{30} different throws of the oscillation parameters.

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/EventRate_VariableGraphs.pdf}
  \end{subfigure}
  \caption{Event rate of the \texttt{SubGeV\_elike\_0dcy} sample as a function of the number of sub-divisions per coarse bin. Each subplot represents the event rate of the sample at a different oscillation parameter set (thrown from the PDG priors). The red line in each subplot represents the mean of the event rate over the different values of sub-divisions for that particular oscillation parameter throw.}
  \label{fig:Oscillation_SK_EventRateVariable}
\end{figure}

Denoting the event rate for one sample for a given throw \quickmath{t} at each \quickmath{N} by \quickmath{\lambda_t^{(N)}}, the average over all considered \quickmath{N} values (\quickmath{\overline \lambda_t = \frac{1}{24} \sum_{N=1}^{24} \lambda_t^{(N)}}) is computed. The variance in the event rate at each \quickmath{N} is then calculated from

\begin{equation}
  \mathrm{Var}\Big[\lambda^{(N)}] = \tfrac{1}{N_\mathrm{throws}} \sum_{t=1}^{N_\mathrm{throws}} \left(\lambda_t^{(N)} - \overline \lambda_t\right)^2 - \left[\tfrac{1}{N_\mathrm{throws}} \sum_{t=1}^{N_\mathrm{throws}} \left(\lambda_t^{(N)} - \overline \lambda_t\right)\right]^2 .
  \label{eq:Oscillation_SK_Variance}
\end{equation}

The aim of the study is to find the lowest value of \quickmath{N} such that this variance is below \quickmath{0.001}. This is the typical threshold used by T2K fitters to validate systematic implementation so is just as applicable to the oscillation probability calculation. The results of this study for each atmospheric sample used within this thesis are illustrated in \autoref{fig:Oscillation_SK_EventRateVariance} for \quickmath{2000} throws of the oscillation parameters. As can be seen, the variance is below the threshold at \quickmath{N = 10}, and is driven primarily by the \texttt{SubGeV\_mulike\_1dcy} and \text{SubGeV\_elike\_0dcy} selections.

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/EventRate_VarianceGraphs.pdf}
  \end{subfigure}
  \caption{Variance of event rate for each atmospheric sample as a function of the number of sub-divisions per coarse bin. The solid red line indicates the \quickmath{0.1\%} threshold and the dashed red line is a graphical indication of the variance at a sub-division \quickmath{N = 10}.}
  \label{fig:Oscillation_SK_EventRateVariance}
\end{figure}

The second study to determine the value of \quickmath{N} is as follows. The likelihood for each sample is computed against an Asimov data set created with oscillation parameters from ``Asimov A'' in \autoref{tab:Oscillation_ParameterSets}. Following \autoref{eq:Oscillation_SK_Variance}, the variance of the log-likelihood over all considered \quickmath{N} is computed. The results are shown in \autoref{fig:Oscillation_SK_LLHVariance}. This tests the impact of the averaging on each sample's binning by reconstructed momentum and/or zenith angle and also provides a scale for the calculation errors compared to their statistical uncertainties. 

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/EventRate_VarianceGraphs.pdf}
  \end{subfigure}
  \caption{Variance of sample likelihood, when compared to `Asimov data' set at Asimov A, for each atmospheric sample as a function of the number of sub-divisions per coarse bin. The solid red line indicates the \quickmath{0.1\%} threshold and the dashed red line is a graphical indication of the variance at a sub-division \quickmath{N = 10}.}
  \label{fig:Oscillation_SK_LLHVariance}
\end{figure}

A choice of \quickmath{N} sub-divisions per coarse bin has a variance in both event rate and log-likelihood residuals less than the required threshold of \quickmath{0.001}. The event rate test is the more stringent test. For the variance of log-likelihood residuals, the largest value is of order \quickmath{10^{-7}}, corresponding to an error on the log-likelihood of about \quickmath{3\times 10^{-4}}, small enough to be negligible for the oscillation analysis.

In practice \autoref{fig:Oscillation_SK_SmearingImplementation} illustrates the effect of the smearing using \quickmath{N = 10}. The fast oscillations in the sub-GeV upgoing region have been replaced with a normalisation effect whilst the large matter resonance structure remains.

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/SmearingImplementation.pdf}
  \end{subfigure}
  \caption{The oscillation probability, \quickmath{P(\nu_{\mu} \rightarrow \nu_{e})} (top row) and \quickmath{P(\nu_{e} \rightarrow \nu_{e})} (bottom row), given as a function of neutrino energy and zenith angle. The left column gives the ``fine'' binning used to calculate the oscillation probabilities and the right column illustrates the ``coarse'' binning used to reweight the MC events. The fine binning choice is given with \quickmath{N = 10}, which was determined to be below threshold from \autoref{fig:Oscillation_SK_EventRateVariance} and \autoref{fig:Oscillation_SK_LLHVariance}.}
  \label{fig:Oscillation_SK_SmearingImplementation}
\end{figure}

\clearpage

\section{Calculation Engine}
\label{sec:Oscillation_CalculationEngine}

As previously discussed in \autoref{sec:Oscillation_FastOscillations}, the calculation of oscillation probabilities is performed at run-time due to utilising continuous oscillation parameters. Consequently, the time per calculation is crucial for fit performance. The fitting framework used for this analysis was developed with \texttt{ProbGPU} \cite{probgpu}. This is a GPU-only implementation of the \text{prob3} engine \cite{Prob3}. It is primarily designed for neutrino propagation in a beam experiment (single layer of constant density) with the atmospheric propagation code not being used prior to the analysis in this thesis.

Another engine, \texttt{CUDAProb3} \cite{cudaprob3}, has been implemented within the fitting framework used within this analysis. It has been specifically optimised for atmospheric neutrino oscillation calculation so unfortunately does not contain the code to replace the beam oscillation calculation. The engine utilises object-orientated techniques as compared to the functional implementation of \texttt{ProbGPU}. This allows the energy and cosine zenith arrays to be kept on GPU memory, rather than having to load these arrays onto GPU memory for each calculation. General memory interfacing is one of the slowest tasks which GPUs can do, so being able to eliminate this significantly reduces the time required for calculation. This can be seen in \autoref{fig:Oscillation_CalculationTime}, where the GPU implementation of \texttt{CUDAProb3} is approximately three times faster than the \texttt{ProbGPU} engine.

\begin{figure}[h]
  \begin{subfigure}[t]{0.8\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/CalculationTime.pdf}
  \end{subfigure}
  \caption{The calculation time taken to both calculate the oscillation probabilities and fill the ``coarse'' oscillograms, following the technique given in \autoref{sec:Oscillation_FastOscillations},  for the \texttt{CUDAProb3} and \texttt{ProbGPU} (Red) calculation engines. \texttt{CUDAProb3} has both a GPU (Blue) and CPU (Black) implementation, where the CPU implementation is multithreaded. Therefore, 8-threads (solid) and 40-threads (dashed) configurations have been used. \texttt{Prob3}, which is a CPU single-thread implementation has a mean step time of \quickmath{1.142\text{s}}.}
  \label{fig:Oscillation_CalculationTime}
\end{figure}

Another significant advantage of \texttt{CUDAProb3} is that it contains a CPU multithreaded implementation which is not possible with the \texttt{ProbGPU} or \texttt{prob3} engines. This eliminates the requirement for GPU resources when submitting jobs to batch systems. As illustrated in \autoref{fig:Oscillation_CalculationTime}, the calculation speed depends on the number of available threads. Using \quickmath{8} threads (which is typical of the batch systems being used) is approximately twice as slow as the \texttt{ProbGPU} engine implementation, but would allow the fitting framework to be run on many more resources. This fact is utilised for any SK-only fits but GPU resources are required for any fits which include beam samples due to the \texttt{ProbGPU} requirement.

\section{Matter Density Profile}
\label{sec:Oscillation_MatterDensity}

For an experiment observing atmospheric neutrinos propagating through the Earth, such as the studies presented in this thesis, a model of the Earth's density and layering is required. The model used within this analysis is the Preliminary Reference Earth Model (PREM) \cite{Dziewonski1981-sp}. This model provides piecewise cubic polynomials as a function of radius which results in the density profile illustrated in \autoref{fig:Oscillation_SK_PREMModelApproximation}. As will be discussed in \autoref{sec:Oscillation_ProdHAvergaing}, the propagator used within the calculation engine requires constant density layers. To follow the official SK-only analysis \cite{thesis_roger}, the average density of each layer has been taken from the PREM model. \autoref{tab:NeutrinoOscillationPhysics_PREMModel} documents the density and radii of the layers used within this approximation.

\begin{figure}[h]
  \begin{subfigure}[t]{0.8\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/DensityComparison.pdf}
  \end{subfigure}
  \caption{The density of the Earth given as a function of the radius, as given by the PREM model (Black) and the constant density four-layer approximation (Blue), as used in the official SK-only analysis.}
  \label{fig:Oscillation_SK_PREMModelApproximation}
\end{figure}

\begin{table}[ht!]
    \centering
    \begin{tabular}{c|c|c|c}
      \hline
      Layer & Outer Radius [\quickmath{\text{km}}] & Density [\quickmath{\text{g/cm}^{3}}] & Chemical composition (Z/A) \\
      \hline
      Inner Core & \quickmath{1220} & \quickmath{13} & \quickmath{0.468 \pm 0.029} \\
      Outer Core & \quickmath{3480} & \quickmath{11.3} & \quickmath{0.468 \pm 0.029} \\
      Lower Mantle & \quickmath{5701} & \quickmath{5.0} & \quickmath{0.496} \\
      Transition Zone & \quickmath{6371} & \quickmath{3.3} & \quickmath{0.496} \\
      \hline
    \end{tabular}
    \caption{Description of the four layers of the Earth invoked within the average constant density approximation of the PREM model \cite{Dziewonski1981-sp}.}
    \label{tab:NeutrinoOscillationPhysics_PREMModel}
\end{table}

The density measurements provided in the PREM model are provided in terms of mass density, whereas neutrino oscillations are sensitive to the electron number density. This value can be computed as the product of the chemical composition, or the \quickmath{Z/A} value, and the mass density of each layer. Currently, the only way to calculate this value for layers close to the Earth's core is through neutrino oscillations. The chemical composition of the upper layers of the Earth's Mantle and the Transition zone is well known due to it being predominantly pyrolite which has a chemical composition value of \quickmath{0.496} \cite{Bourret_2017}. The components of the Earth's core region are less well known. Consequently, the chemical composition dial for the core layers is set to a value of \quickmath{0.468} \cite{Rott2015}. This value is assigned a Gaussian error with a standard deviation equivalent to the difference in chemical composition in core and mantle layers. \autoref{fig:Oscillation_SK_ChemicalComposition} illustrates the effect of moving from the \quickmath{Z/A = 0.5} method which is used in the official SK-only analysis \cite{thesis_roger} to more precise values recorded by other neutrino experiments.

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/ChemicalComposition.pdf}
  \end{subfigure}
  \caption{The oscillation probability, \quickmath{P(\nu_{\mu} \rightarrow \nu_{e})} (top row) and \quickmath{P(\nu_{e} \rightarrow \nu_{e})} (bottom row), given as a function of neutrino energy and zenith angle. The left column gives probabilities where the constant \quickmath{Z/A = 0.5} approximation which is used in the official SK-only analysis. The middle column gives the probabilities where the more accurate \quickmath{Z/A = [0.468,0.498]} values as given in \autoref{tab:NeutrinoOscillationPhysics_PREMModel}. The right column illustrates the difference in oscillation probability between the two different techniques.}
  \label{fig:Oscillation_SK_ChemicalComposition}
\end{figure}

The beam oscillation probability in this thesis uses a baseline of \quickmath{295 \text{km}}, density \quickmath{2.6 \text{g/cm}^{3}} \cite{Hagiwara2011}, and chemical composition \quickmath{0.5} as is done by the official T2K-only analysis.

Whilst the propagator requires a fixed density layer model of the Earth, the density only has to be fixed for a specific neutrino energy \quickmath{\times \cos(\theta_{Z})} bin in a given layer (I.e. set of values at which to calculate the oscillation probability). As the density is a function of radius, which is a function of the direction in which a neutrino propagates, a better approximation of the PREM model can be made if a \quickmath{\cos(\theta_{Z})}-specific density is calculated. 

To achieve this, the average density, \quickmath{\left< \rho \right>_{i}}, in the \quickmath{i^{th}} layer, is calculated as the density, \quickmath{\rho}, integrated over the track a given \quickmath{\cos(\theta_{Z})},

\begin{equation}
  \left< \rho \right>_{i} = \frac{1}{t_{i+1}-t_{i}} \int^{t_{i}+1}_{t_{i}} \rho(t) dt
\end{equation}

where \quickmath{t_{i}} are the intersection points between each layer and \quickmath{t} is the path length of the trajectory across the layer which is dependent upon \quickmath{\cos(\theta_{Z})}.

The oscillation probability calculation speed is approximately linear in the number of layers invoked within the Earth model. Therefore a four-layer model is still utilized with the only difference to the above example being that the four-layer model used for each value of \quickmath{\cos(\theta_{Z})} is different. Following the method outlined in \cite{EarthGrav}, a four-layer piecewise quadratic polynomial is fit to the PREM model for the four layers defined in \autoref{tab:NeutrinoOscillationPhysics_PREMModel}. This fit was not performed by the author of the thesis and is documented in \cite{t2k_tn_425}. The coefficients of the quadratic fit to each layer are given in \autoref{tab:NeutrinoOscillationPhysics_AveragePREMModel} with the final distribution illustrated in \autoref{fig:Oscillation_SK_PREMModelApproximationWithAveragePREMModel}. The quadratic approximation is clearly much closer to the PREM model as compared to the constant density approximation.

\begin{figure}[h]
  \begin{subfigure}[t]{0.8\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/DensityComparisonWithAveragePREM.pdf}
  \end{subfigure}
  \caption{The density of the Earth given as a function of the radius, as given by the PREM model (Black), the constant density four-layer approximation (Blue), as used in the official SK-only analysis, and the quadratic approximation of the PREM model (Red).}
  \label{fig:Oscillation_SK_PREMModelApproximationWithAveragePREMModel}
\end{figure}

\begin{table}[ht!]
    \centering
    \begin{tabular}{c|c|c}
      \hline
      Layer & Outer Radius [\quickmath{\text{km}}] & Density [\quickmath{\text{g/cm}^{3}}] \\
      \hline
      Inner Core & \quickmath{1220} & \quickmath{13.09 - 8.84 x^{2}} \\
      Outer Core & \quickmath{3480} & \quickmath{12.31 + 1.09 x - 10.02 x^{2}} \\
      Lower Mantle & \quickmath{5701} & \quickmath{6.78 - 1.56 x - 1.25 x^{2}} \\
      Transition Zone & \quickmath{6371} & \quickmath{-50.42 + 123.33 x - 69.95 x^{2}} \\
      \hline
    \end{tabular}
    \caption{The quadratic polynomial fits to the PREM model for four assumed layers of the PREM model. The fit to calculate the coefficients is given in \cite{t2k_tn_425}, where \quickmath{x = R/R_{Earth}}.}
    \label{tab:NeutrinoOscillationPhysics_AveragePREMModel}
\end{table}

The effect of using the average density per \quickmath{\cos(\theta_{Z})} model is highlighted in \autoref{fig:Oscillation_SK_AverageDensityPREMModel}. The slight discontinuity in the oscillation probability around \quickmath{\cos(\theta_{Z}) \sim -0.45} in the fixed density model, which is due to the transition to mantle layer boundary, has been reduced. This is expected as the difference in the density across this boundary is significantly smaller in the average density model as compared to the constant density model. Whilst the difference in density across the other layer transitions is reduced, there is still a significant difference. This means the discontinuities in the oscillation probabilities remain but are significantly reduced. However, as the average density approximation matches the PREM model well in this region, these discontinuities are due to the Earth model rather than an artifact of the oscillation calculation.

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/AverageDensityPREMModel.pdf}
  \end{subfigure}
  \caption{The oscillation probability, \quickmath{P(\nu_{\mu} \rightarrow \nu_{e})} (top row) and \quickmath{P(\nu_{e} \rightarrow \nu_{e})} (bottom row), given as a function of neutrino energy and zenith angle. The left column gives probabilities where the four-layer constant density approximation is used. The middle column gives the probabilities where the density is integrated over the trajectory, using the quadratic PREM approximation, for each \quickmath{\cos(\theta_{Z})} is used. The right column illustrates the difference in oscillation probability between the two different techniques.}
  \label{fig:Oscillation_SK_AverageDensityPREMModel}
\end{figure}

\clearpage

\section{Production Height Averaging}
\label{sec:Oscillation_ProdHAvergaing}

As discussed in \autoref{sec:Oscillation_Overview}, the height at which the cosmic ray flux interacts in the atmosphere is not known on an event-by-event basis. The production height can vary from the Earth's surface to \quickmath{50\text{km}} above that. The SK-only analysis methodology (described in \autoref{sec:Oscillation_FastOscillations}) for including the uncertainty on the production height is to include variations from the Honda model when pre-calculating the oscillation probabilities prior to the fit. This technique is not possible for this analysis which uses continuous oscillation parameters that can not be known prior to the fit. Consequently, an analytical averaging technique was developed in \cite{t2k_tn_425}. The author of this thesis was not responsible for the derivation of the technique but has performed the implementation and validation of the technique for this analysis alone.

The oscillation probability used within this analysis is based on \cite{Barger:1980tf}. The neutrino wavefunction in the vacuum Hamiltonian evolves in each layer of constant matter density via

\begin{equation}
  i \frac{d\psi_{j}(t)}{dt} = \frac{m_{j}^{2}}{2E_{\nu}} \psi_{j}(t) - \sum_{k} \sqrt{2} G_{F} N_{e} U_{ej} U_{ke}^{\dagger} \psi_{k}(t),
\end{equation}

where \quickmath{m_{j}^{2}} is the square of the \quickmath{j^{th}} vacuum eigenstate mass, \quickmath{E_{\nu}} is the neutrino energy, \quickmath{G_{F}} is Fermi's constant, \quickmath{N_{e}} is the electron number density and \quickmath{U} is the PMNS matrix. \quickmath{N_{e} \rightarrow -N_{e}} and \quickmath{\delta_{CP} \rightarrow -\delta_{CP}} for antineutrino propagation.

Using the \quickmath{20} production heights per MC neutrino event, provided as \quickmath{5\%} percentiles from the Honda flux model, a production height distribution \quickmath{p_{j}(h | E_{\nu}, \cos{\theta_{Z}})} is built for each neutrino flavour \quickmath{j = {\nu_{e}, \bar{\nu}_{e}, \nu_{\mu}, \bar{\nu}_{\mu}}}. In practice, a histogram is filled with \quickmath{20} evenly spaced bins in production height \quickmath{h} between \quickmath{0} and \quickmath{50\text{km}}. The neutrino energy and cosine zenith binning is the same as that provided in \autoref{sec:Oscillation_FastOscillations}. The average production height, \quickmath{\bar{h} = \int dh \frac{1}{4} \sum_{j} p_{j}(h | E_{\nu}, \cos(\theta_{Z}))}, is calculated. The production height binning of this histogram is then translated into \quickmath{\delta t(h) = t(z,\bar{h}) - t(z,h)}, where \quickmath{t(z,h)} is the distance travelled along the trajectory.

\iffalse
Using the path length distrubitions from the Honda flux, the production height can be calculated via,
\begin{equation}
  h = \sqrt{L^{2} + 2LR_{SK} \cos(\theta_{Z}) + R_{SK}^{2}} - R_{Earth}
\end{equation}
where \quickmath{L} is the path length provided from the Honda flux model and \quickmath{R_{SK} = R_{Earth} + 380\text{m}} is the elevation of the SK detector.
\fi

For the \quickmath{i^{th}} travsered layer, the transition amplitude, \quickmath{D_{i}(t_{i+1},t_{i})}, is computed. The time ordered product of these is then used as the overall transition amplitude via

\begin{equation}
  \label{eq:Oscillation_FullTransitionAmplitude}
  \begin{split}
    A(t_{n+1},t_{0}) &= D_{n}(t_{n+1},t_{n})...D_{1}(t_{2},t_{1})D_{0}(t_{1},t_{0}), \\
  \end{split}
\end{equation}

where,

\begin{equation}
  \label{eq:Oscillation_LayerTransitionAmplitude}
  \begin{split}
    D_{n}(t_{n+1},t_{n}) &= \exp[-i H_{n}(t_{n+1} - t_{n})] \\
    &= \sum^{3}_{k=1} C_{k} \exp[ia_{k} \delta t]
    \end{split}
\end{equation}

is expressed as a diagonalised time-dependent solution to the schrodinger equation. The \quickmath{0^{th}} layer is the propagation through the atmosphere and is the only term which depends on the production height. Using the subsitution \quickmath{t_{0} = t(\bar{h}) - \delta t(h)}, it can be shown that

\begin{equation}
  D_{0}(t_{1},t_{0}) &= D_{0}(t_{1},\bar{h})D_{0}(\delta t).
\end{equation}  

\iffalse
\begin{equation}
  U_{n}(t_{n+1},t_{n}) &= \exp[-i H_{n}(t_{n+1} - t_{n})] , \\
  &= V \exp[-i A (t_{n+1} - t_{n})] V , \\
  H &= \sum_{k} u(k) a(k) u(k)^{\dagger}, \\
  V &= u \text{i.e. eigenvector} \\
  A &= a \text{i.e. diagonal} \\
  H &= V A V^{\dagger}, \\
  U_{0}(t_{n+1},t_{n}) &= V \exp[-i A (t_{n+1} - t_{n})] V^{\dagger}, \\
  U_{0}(t_{1},t_{0}) &= U_{n}(t_{1},\bar{h}-\delta t),\\
  &= V \exp[-i A (t_{1} - (\bar{h} - \delta t))] V^{\dagger}, \\
  &= V \exp-[i A (t_{1} - \bar{h})] \exp[i A \delta t))] V^{\dagger}, \\
  &= V \exp-[i A (t_{1} - \bar{h})] V^{\dagger} V \exp[i A \delta t))] V^{\dagger}, \\
  &= U(t_{1},\bar{h}) U(\delta t), \\
  V^{\dagger} V &= 1, \\
\end{equation}
\fi

Thus \autoref{eq:Oscillation_FullTransitionAmplitude} becomes

\begin{equation}
  \begin{split}
    A(t_{n+1},t_{0}) &= D_{n}(t_{n+1},t_{n})...D_{1}(t_{2},t_{1})D_{0}(t_{1},\bar{h})D(\delta t) \\
    &= A(t_{n+1},\bar{h}) \sum_{k=1}^{3} C_{k} \exp[ia_{k} \delta t], \\
    &= \sum_{k=1}^{3} B_{k} \exp[ia_{k} \delta t].
  \end{split}
\end{equation}

The oscillation probability averaged over production height is calculated as

\begin{equation}
  \begin{split}
    \overline P(\nu_{j} \rightarrow \nu_{i}) &= \int d(\delta t) p_{j}(\delta t|E_{\nu}, \cos\theta_{Z}) P(\nu_{j} \rightarrow \nu_{i}) \\
    &= \int d(\delta t) p_{j}(\delta t|E_{\nu}, \cos\theta_{Z})	A(t_{n+1},t_{0}) A^{*}(t_{n+1},t_{0}) \\
    &= \sum_{km} (B_{k})_{ij} (B_{m})^{*}_{ij} \int d(\delta t) p_{j}(\delta t|E_{\nu}, \cos\theta_{Z}) \exp[i(a_{k}-a_{m})\delta t]
  \end{split}
\end{equation}

In practice, implementation in CUDAProb3 \cite{cudaprob3} is relatively straightforward as the majority of these terms are already calculated in the standard oscillation calculation. \autoref{fig:Oscillation_SK_ProductionHeightAveraging} illustrates the results of the production height averaging. As expected, the main effect is observed in the low-energy downward-going and horizontal-going events. Upward-going events have to travel the radius of the Earth, \quickmath{R_{E} = 6371\text{km}}, where the production height uncertainty is a small fraction of the total path length. 

\begin{figure}[h]
  \begin{subfigure}[t]{\textwidth}
    \includegraphics[width=\textwidth, trim={0mm 0mm 0mm 0mm}, clip,page=1]{Figures/Oscillation/ProductionHeightAveraging.pdf}
  \end{subfigure}
  \caption{The oscillation probability, \quickmath{P(\nu_{\mu} \rightarrow \nu_{e})} (top row) and \quickmath{P(\nu_{e} \rightarrow \nu_{e})} (bottom row), given as a function of neutrino energy and zenith angle. The left column gives probabilities where a fixed production height of \quickmath{25\text{km}} is used. The middle column gives the probabilities where the production height is analytically averaged. The right column illustrates the difference in oscillation probability between the two different techniques.}
  \label{fig:Oscillation_SK_ProductionHeightAveraging}
\end{figure}
